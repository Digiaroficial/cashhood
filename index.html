<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CashHood - Intercambio de Efectivo</title>
    <!-- Incluye Tailwind CSS desde CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
        }
    </style>
</head>
<body class="bg-gray-100">
    <div id="root"></div>

    <!-- Carga de las bibliotecas de React y Babel -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Carga de las bibliotecas de Firebase como módulos -->
    <script type="module">
        // Importaciones del SDK de Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
        import { getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged, signOut, signInWithEmailAndPassword, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-auth.js";
        import { getFirestore, doc, setDoc, updateDoc, collection, onSnapshot, addDoc, query } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore.js";

        /**
         * Inicializa Firebase y expone los servicios a una variable global.
         */
        const initFirebase = () => {
            // Variables globales proporcionadas por el entorno
            const __app_id = typeof window.__app_id !== 'undefined' ? window.__app_id : 'default-app-id';
            const __firebase_config = typeof window.__firebase_config !== 'undefined' ? JSON.parse(window.__firebase_config) : {
                apiKey: "AIzaSyDZmLQ2c5l0J27mgPHaIz9zXnxrDWPlsNM",
                authDomain: "cashhood-9bcdd.firebaseapp.com",
                projectId: "cashhood-9bcdd",
                storageBucket: "cashhood-9bcdd.firebasestorage.app",
                messagingSenderId: "1023739045278",
                appId: "1:1023739045278:web:671bdb91f3585961b7628f",
                measurementId: "G-37KF9F9SYW"
            };
            const __initial_auth_token = typeof window.__initial_auth_token !== 'undefined' ? window.__initial_auth_token : undefined;

            try {
                const app = initializeApp(__firebase_config);
                const auth = getAuth(app);
                const db = getFirestore(app);

                // Crear un objeto global para exponer Firebase a la aplicación de React
                window.firebase = {
                    app,
                    db,
                    auth: {
                        instance: auth,
                        onAuthStateChanged,
                        signInWithCustomToken,
                        signInAnonymously,
                        signOut,
                        signInWithEmailAndPassword,
                        createUserWithEmailAndPassword
                    },
                    firestore: {
                        doc,
                        setDoc,
                        updateDoc,
                        collection,
                        onSnapshot,
                        addDoc,
                        query
                    },
                    appId: __app_id
                };

                // Autenticación inicial
                if (__initial_auth_token) {
                    signInWithCustomToken(auth, __initial_auth_token).catch((error) => {
                        console.error("Error al iniciar sesión con token personalizado:", error);
                        signInAnonymously(auth);
                    });
                } else {
                    signInAnonymously(auth);
                }

                console.log("Firebase inicializado con éxito.");
            } catch (error) {
                console.error("Error al inicializar Firebase:", error);
            }
        };

        // Llama a la función de inicialización cuando el script se carga
        initFirebase();
    </script>

    <!-- Script de la aplicación React -->
    <script type="text/babel">
        const { useState, useEffect } = React;

        // Componente de ícono de mapa simulado
        const MapIcon = () => (
            <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
            </svg>
        );

        // Constantes para las rutas de Firestore
        const FIREBASE_COLLECTION_USERS = 'users';
        const FIREBASE_COLLECTION_REQUESTS = 'requests';

        function App() {
            const [user, setUser] = useState(null);
            const [isAuthReady, setIsAuthReady] = useState(false);
            const [loading, setLoading] = useState(true);
            const [message, setMessage] = useState('');
            const [page, setPage] = useState('login'); // 'login', 'dashboard', 'map', 'my-requests', 'create-request'
            const [requests, setRequests] = useState([]);
            const [userLocation, setUserLocation] = useState(null);
            const [geolocationStatus, setGeolocationStatus] = useState('calculando'); // 'calculando', 'disponible', 'denegado'

            const userId = user?.uid || 'anonymous';
            const appId = window.firebase?.appId || 'default-app-id';

            // Sincronizar el estado de la autenticación
            useEffect(() => {
                const firebaseAuth = window.firebase?.auth;
                if (!firebaseAuth) {
                    console.error("Firebase Auth no está disponible.");
                    return;
                }
                
                const unsubscribe = firebaseAuth.onAuthStateChanged(firebaseAuth.instance, async (currentUser) => {
                    setUser(currentUser);
                    setIsAuthReady(true);
                    setLoading(false);
                    if (currentUser) {
                        setPage('dashboard');
                        // Intenta guardar o actualizar el perfil del usuario en Firestore
                        try {
                            const { doc, updateDoc, setDoc } = window.firebase.firestore;
                            const db = window.firebase.db;
                            const userRef = doc(db, `/artifacts/${appId}/users/${currentUser.uid}/profile/${currentUser.uid}`);
                            await updateDoc(userRef, {
                                email: currentUser.email,
                                displayName: currentUser.displayName,
                                lastLogin: new Date()
                            }, { merge: true });
                        } catch (error) {
                            // Si la actualización falla (el documento no existe), intenta crearlo
                            try {
                                const { doc, setDoc } = window.firebase.firestore;
                                const db = window.firebase.db;
                                const userRef = doc(db, `/artifacts/${appId}/users/${currentUser.uid}/profile/${currentUser.uid}`);
                                await setDoc(userRef, {
                                    uid: currentUser.uid,
                                    email: currentUser.email,
                                    displayName: currentUser.displayName,
                                    createdAt: new Date(),
                                    lastLogin: new Date()
                                });
                            } catch (creationError) {
                                console.error("Error al crear el perfil del usuario:", creationError);
                            }
                        }
                    } else {
                        setPage('login');
                    }
                });
                return () => unsubscribe();
            }, []);

            // Listener de Firestore en tiempo real para las solicitudes
            useEffect(() => {
                const firebaseServices = window.firebase;
                // Espera a que la autenticación esté lista antes de suscribirse
                if (!isAuthReady || !firebaseServices) return;
                
                const db = firebaseServices.db;
                const { collection, onSnapshot, query } = firebaseServices.firestore;
                
                // Lee las solicitudes del path público, que solo tiene permisos de lectura
                const q = query(
                    collection(db, `/artifacts/${appId}/public/data/${FIREBASE_COLLECTION_REQUESTS}`)
                );

                const unsubscribe = onSnapshot(q, (querySnapshot) => {
                    const requestsData = querySnapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));
                    setRequests(requestsData);
                }, (error) => {
                    console.error("Error al cargar las solicitudes:", error);
                    setMessage("Error al cargar las solicitudes. Por favor, inténtalo de nuevo.");
                });

                return () => unsubscribe();
            }, [isAuthReady]);


            // Geolocation
            useEffect(() => {
                if ("geolocation" in navigator) {
                    const geoOptions = {
                        enableHighAccuracy: true,
                        timeout: 5000,
                        maximumAge: 0
                    };
                    const geoSuccess = (position) => {
                        setUserLocation({
                            lat: position.coords.latitude,
                            lng: position.coords.longitude
                        });
                        setGeolocationStatus('disponible');
                    };
                    const geoError = (error) => {
                        console.error("Error al obtener la ubicación:", error.message || error);
                        setMessage("Por favor, habilita la ubicación para usar la función de vecinos cercanos.");
                        setGeolocationStatus('denegado');
                    };
                    const watchId = navigator.geolocation.watchPosition(geoSuccess, geoError, geoOptions);
                    return () => navigator.geolocation.clearWatch(watchId);
                } else {
                    setMessage("La geolocalización no está disponible en este navegador.");
                    setGeolocationStatus('denegado');
                }
            }, []);

            const handleLogin = async (email, password) => {
                const { signInWithEmailAndPassword, instance: authInstance } = window.firebase.auth || {};
                if (!authInstance) {
                    setMessage("Error: El servicio de autenticación no está disponible.");
                    return;
                }
                try {
                    setLoading(true);
                    await signInWithEmailAndPassword(authInstance, email, password);
                    setMessage('Inicio de sesión exitoso.');
                } catch (error) {
                    const friendlyMessage = getAuthErrorMessage(error.code);
                    setMessage(friendlyMessage);
                    console.error("Login error:", error);
                } finally {
                    setLoading(false);
                }
            };

            const handleRegister = async (email, password) => {
                const { createUserWithEmailAndPassword, instance: authInstance } = window.firebase.auth || {};
                if (!authInstance) {
                    setMessage("Error: El servicio de autenticación no está disponible.");
                    return;
                }
                try {
                    setLoading(true);
                    await createUserWithEmailAndPassword(authInstance, email, password);
                    setMessage('Registro exitoso. Has iniciado sesión.');
                } catch (error) {
                    const friendlyMessage = getAuthErrorMessage(error.code);
                    setMessage(friendlyMessage);
                    console.error("Registration error:", error);
                } finally {
                    setLoading(false);
                }
            };

            const handleLogout = async () => {
                const { signOut, instance: authInstance } = window.firebase.auth || {};
                if (!authInstance) return;
                try {
                    await signOut(authInstance);
                    setMessage('Has cerrado sesión.');
                    setPage('login');
                } catch (error) {
                    console.error("Error al cerrar sesión:", error);
                    setMessage(`Error al cerrar sesión: ${error.message}`);
                }
            };

            const createExchangeRequest = async (amount, exchangeType) => {
                const firebaseServices = window.firebase;
                if (!user || !userLocation || !firebaseServices) {
                    setMessage("Error: Debes iniciar sesión y habilitar tu ubicación para crear una solicitud.");
                    return;
                }
                const db = firebaseServices.db;
                try {
                    setLoading(true);
                    const { collection, addDoc } = firebaseServices.firestore;
                    // Intenta escribir en la colección pública. Si esto falla, es un problema de permisos.
                    const requestsCollectionRef = collection(db, `/artifacts/${appId}/public/data/${FIREBASE_COLLECTION_REQUESTS}`);
                    await addDoc(requestsCollectionRef, {
                        requesterId: user.uid,
                        requesterEmail: user.email,
                        amount: parseFloat(amount),
                        exchangeType: exchangeType,
                        status: 'pending',
                        requesterLocation: userLocation,
                        createdAt: new Date().toISOString()
                    });
                    setMessage('Solicitud de intercambio creada con éxito.');
                    setPage('dashboard');
                } catch (error) {
                    console.error("Error al crear la solicitud:", error);
                    if (error.code && error.code === 'permission-denied') {
                         setMessage("Error de permisos: Las reglas de seguridad de Firestore no permiten crear una solicitud en esta colección pública. Por favor, contacta al administrador.");
                    } else {
                        setMessage(`Error al crear la solicitud: ${error.message}`);
                    }
                } finally {
                    setLoading(false);
                }
            };

            const handleAcceptRequest = async (requestId) => {
                const firebaseServices = window.firebase;
                if (!user || !firebaseServices) {
                    setMessage("Error: Debes iniciar sesión para aceptar una solicitud.");
                    return;
                }
                const db = firebaseServices.db;
                try {
                    setLoading(true);
                    const { doc, updateDoc } = firebaseServices.firestore;
                    const requestRef = doc(db, `/artifacts/${appId}/public/data/${FIREBASE_COLLECTION_REQUESTS}`, requestId);
                    await updateDoc(requestRef, {
                        status: 'accepted',
                        accepterId: user.uid,
                        acceptedAt: new Date().toISOString()
                    });
                    setMessage('Solicitud aceptada. ¡Contacta al vecino para coordinar el intercambio!');
                    setPage('my-requests');
                } catch (error) {
                    console.error("Error al aceptar la solicitud:", error);
                    if (error.code && error.code === 'permission-denied') {
                         setMessage("Error de permisos: Las reglas de seguridad de Firestore no permiten aceptar esta solicitud. Por favor, contacta al administrador.");
                    } else {
                        setMessage(`Error al aceptar la solicitud: ${error.message}`);
                    }
                } finally {
                    setLoading(false);
                }
            };

            const getAuthErrorMessage = (code) => {
                switch (code) {
                    case 'auth/invalid-email':
                        return 'El formato del correo electrónico no es válido.';
                    case 'auth/user-not-found':
                    case 'auth/wrong-password':
                        return 'Correo o contraseña incorrectos.';
                    case 'auth/email-already-in-use':
                        return 'El correo electrónico ya está en uso.';
                    case 'auth/weak-password':
                        return 'La contraseña es demasiado débil (debe tener al menos 6 caracteres).';
                    default:
                        return `Ocurrió un error de autenticación: ${code}`;
                }
            };

            const getDistance = (loc1, loc2) => {
                if (!loc1 || !loc2) return 'Desconocida';
                const R = 6371; // Radio de la Tierra en km
                const dLat = (loc2.lat - loc1.lat) * Math.PI / 180;
                const dLon = (loc2.lng - loc1.lng) * Math.PI / 180;
                const a =
                    Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                    Math.cos(loc1.lat * Math.PI / 180) * Math.cos(loc2.lat * Math.PI / 180) *
                    Math.sin(dLon / 2) * Math.sin(dLon / 2);
                const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
                return (R * c).toFixed(2); // Distancia en km
            };

            const renderPage = () => {
                if (loading) {
                    return (
                        <div className="flex items-center justify-center min-h-screen bg-gray-100">
                            <div className="text-xl font-semibold text-gray-700">Cargando aplicación...</div>
                        </div>
                    );
                }

                switch (page) {
                    case 'login':
                        return <AuthPage onLogin={handleLogin} onRegister={handleRegister} message={message} />;
                    case 'dashboard':
                        return <DashboardPage user={user} userId={userId} onLogout={handleLogout} setPage={setPage} />;
                    case 'map':
                        return <MapPage requests={requests.filter(req => req.status === 'pending' && req.requesterId !== user.uid)} userLocation={userLocation} getDistance={getDistance} onAccept={handleAcceptRequest} setPage={setPage} geolocationStatus={geolocationStatus} />;
                    case 'my-requests':
                        const myRequests = requests.filter(req => req.requesterId === user.uid || req.accepterId === user.uid);
                        return <MyRequestsPage requests={myRequests} userId={user.uid} setPage={setPage} />;
                    case 'create-request':
                        return <CreateRequestPage onCreate={createExchangeRequest} setPage={setPage} userLocation={userLocation} geolocationStatus={geolocationStatus} />;
                    default:
                        return <AuthPage onLogin={handleLogin} onRegister={handleRegister} message={message} />;
                }
            };

            return (
                <div className="min-h-screen bg-gray-100 font-inter">
                    {message && (
                        <div className="bg-blue-500 text-white p-3 text-center fixed top-0 w-full z-50">
                            {message}
                        </div>
                    )}
                    {renderPage()}
                </div>
            );
        }

        // --- Componentes ---

        const AuthPage = ({ onLogin, onRegister, message }) => {
            const [isLogin, setIsLogin] = useState(true);
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [passwordConfirm, setPasswordConfirm] = useState('');
            const [localMessage, setLocalMessage] = useState('');

            const handleSubmit = (e) => {
                e.preventDefault();
                setLocalMessage('');
                if (isLogin) {
                    onLogin(email, password);
                } else {
                    if (password !== passwordConfirm) {
                        setLocalMessage('Las contraseñas no coinciden.');
                        return;
                    }
                    onRegister(email, password);
                }
            };

            return (
                <div className="flex items-center justify-center min-h-screen bg-gray-100 p-4">
                    <div className="bg-white p-8 rounded-2xl shadow-xl w-full max-w-md">
                        <h1 className="text-3xl font-bold mb-6 text-center text-gray-800">
                            Bienvenido a CashHood
                        </h1>
                        <p className="text-center text-gray-600 mb-6">{isLogin ? 'Inicia sesión para empezar.' : 'Crea tu cuenta para empezar.'}</p>
                        {message && <div className="bg-blue-100 border border-blue-400 text-blue-700 px-4 py-3 rounded mb-4 text-sm">{message}</div>}
                        {localMessage && <div className="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4 text-sm">{localMessage}</div>}

                        <form onSubmit={handleSubmit} className="space-y-4">
                            <div>
                                <label className="block text-sm font-medium text-gray-700">Correo Electrónico</label>
                                <input
                                    type="email"
                                    value={email}
                                    onChange={(e) => setEmail(e.target.value)}
                                    required
                                    className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                                />
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-gray-700">Contraseña</label>
                                <input
                                    type="password"
                                    value={password}
                                    onChange={(e) => setPassword(e.target.value)}
                                    required
                                    className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                                />
                            </div>
                            {!isLogin && (
                                <div>
                                    <label className="block text-sm font-medium text-gray-700">Confirmar Contraseña</label>
                                    <input
                                        type="password"
                                        value={passwordConfirm}
                                        onChange={(e) => setPasswordConfirm(e.target.value)}
                                        required
                                        className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                                    />
                                </div>
                            )}
                            <button
                                type="submit"
                                className="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-150 ease-in-out"
                            >
                                {isLogin ? 'Iniciar Sesión' : 'Registrarse'}
                            </button>
                        </form>
                        <div className="mt-6 text-center">
                            <button onClick={() => setIsLogin(!isLogin)} className="text-sm font-medium text-blue-600 hover:text-blue-500">
                                {isLogin ? '¿No tienes una cuenta? Regístrate' : '¿Ya tienes una cuenta? Inicia sesión'}
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        const DashboardPage = ({ user, userId, onLogout, setPage }) => {
            return (
                <div className="min-h-screen bg-gray-100 flex flex-col items-center p-4">
                    <div className="bg-white p-6 rounded-2xl shadow-xl w-full max-w-lg mt-10">
                        <h1 className="text-3xl font-bold text-gray-800 mb-2">Panel de Control de CashHood</h1>
                        <p className="text-gray-600 mb-6">Bienvenido, {user?.email || 'vecino anónimo'}.</p>
                        <div className="p-4 bg-gray-50 rounded-lg text-sm text-gray-500 break-all mb-4">
                            <p className="font-semibold">Tu ID de usuario es:</p>
                            <p>{userId}</p>
                        </div>
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <button onClick={() => setPage('create-request')} className="w-full flex items-center justify-center py-3 px-4 rounded-xl shadow-md text-sm font-semibold text-white bg-green-500 hover:bg-green-600 transition duration-150 ease-in-out">
                                <span className="mr-2">+</span> Crear Solicitud
                            </button>
                            <button onClick={() => setPage('map')} className="w-full flex items-center justify-center py-3 px-4 rounded-xl shadow-md text-sm font-semibold text-white bg-blue-500 hover:bg-blue-600 transition duration-150 ease-in-out">
                                <MapIcon /> <span className="ml-2">Ver Vecinos</span>
                            </button>
                            <button onClick={() => setPage('my-requests')} className="w-full flex items-center justify-center py-3 px-4 rounded-xl shadow-md text-sm font-semibold text-white bg-yellow-500 hover:bg-yellow-600 transition duration-150 ease-in-out">
                                Mis Solicitudes
                            </button>
                            <button onClick={onLogout} className="w-full flex items-center justify-center py-3 px-4 rounded-xl shadow-md text-sm font-semibold text-white bg-red-500 hover:bg-red-600 transition duration-150 ease-in-out">
                                Cerrar Sesión
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        const CreateRequestPage = ({ onCreate, setPage, userLocation, geolocationStatus }) => {
            const [amount, setAmount] = useState('');
            const [exchangeType, setExchangeType] = useState('cash'); // Default to cash
            const [localMessage, setLocalMessage] = useState('');
            const [isSubmitting, setIsSubmitting] = useState(false);

            const handleSubmit = async (e) => {
                e.preventDefault();
                setLocalMessage('');
                if (parseFloat(amount) <= 0 || isNaN(parseFloat(amount))) {
                    setLocalMessage('El monto debe ser un número válido mayor que 0.');
                    return;
                }
                setIsSubmitting(true);
                await onCreate(amount, exchangeType);
                setIsSubmitting(false);
            };

            const isButtonDisabled = isSubmitting || geolocationStatus !== 'disponible';
            const buttonText = isSubmitting ? 'Enviando...' : 'Enviar Solicitud';

            return (
                <div className="min-h-screen bg-gray-100 flex flex-col items-center p-4">
                    <div className="bg-white p-6 rounded-2xl shadow-xl w-full max-w-lg mt-10">
                        <h1 className="text-3xl font-bold text-gray-800 mb-4">Crear Nueva Solicitud en CashHood</h1>
                        {localMessage && <div className="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4 text-sm">{localMessage}</div>}
                        {geolocationStatus === 'calculando' && (
                            <div className="bg-blue-100 border border-blue-400 text-blue-700 px-4 py-3 rounded mb-4 text-sm text-center animate-pulse">
                                Calculando tu ubicación...
                            </div>
                        )}
                        {geolocationStatus === 'denegado' && (
                            <div className="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4 text-sm text-center">
                                Por favor, habilita la geolocalización en la configuración de tu navegador para crear una solicitud.
                            </div>
                        )}
                        <form onSubmit={handleSubmit} className="space-y-4">
                            <div>
                                <label className="block text-sm font-medium text-gray-700">Monto a intercambiar (ej. 100)</label>
                                <input
                                    type="number"
                                    value={amount}
                                    onChange={(e) => setAmount(e.target.value)}
                                    required
                                    min="1"
                                    className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                                />
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1">Tipo de Intercambio</label>
                                <div className="flex gap-4">
                                    <label className="inline-flex items-center">
                                        <input
                                            type="radio"
                                            name="exchangeType"
                                            value="cash"
                                            checked={exchangeType === 'cash'}
                                            onChange={() => setExchangeType('cash')}
                                            className="form-radio text-blue-600"
                                        />
                                        <span className="ml-2 text-gray-700">Efectivo</span>
                                    </label>
                                    <label className="inline-flex items-center">
                                        <input
                                            type="radio"
                                            name="exchangeType"
                                            value="transfer"
                                            checked={exchangeType === 'transfer'}
                                            onChange={() => setExchangeType('transfer')}
                                            className="form-radio text-blue-600"
                                        />
                                        <span className="ml-2 text-gray-700">Transferencia</span>
                                    </label>
                                </div>
                            </div>
                            <div className="flex gap-4">
                                <button
                                    type="submit"
                                    disabled={isButtonDisabled}
                                    className={`flex-1 py-3 px-4 border border-transparent rounded-md shadow-md text-sm font-semibold text-white transition duration-150 ease-in-out ${isButtonDisabled ? 'bg-gray-400 cursor-not-allowed' : 'bg-green-500 hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500'}`}
                                >
                                    {buttonText}
                                </button>
                                <button
                                    type="button"
                                    onClick={() => setPage('dashboard')}
                                    className="flex-1 py-3 px-4 border border-gray-300 rounded-md shadow-md text-sm font-semibold text-gray-700 bg-white hover:bg-gray-50 transition duration-150 ease-in-out"
                                >
                                    Volver al Panel de Control
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        };

        const MapPage = ({ requests, userLocation, getDistance, onAccept, setPage, geolocationStatus }) => {
            return (
                <div className="min-h-screen bg-gray-100 flex flex-col items-center p-4">
                    <div className="bg-white p-6 rounded-2xl shadow-xl w-full max-w-4xl mt-10">
                        <h1 className="text-3xl font-bold text-gray-800 mb-4">Vecinos Cercanos en CashHood</h1>
                        <div className="relative w-full h-96 bg-gray-200 rounded-xl shadow-inner overflow-hidden mb-6 flex items-center justify-center">
                            <p className="text-gray-500 font-semibold text-center p-4">
                                [ Mapa de ubicación simulado ]<br />
                                Tu ubicación actual: {geolocationStatus === 'calculando' ? 'Calculando...' : userLocation ? `${userLocation.lat.toFixed(4)}, ${userLocation.lng.toFixed(4)}` : 'Geolocalización no disponible'}
                            </p>
                        </div>
                        {geolocationStatus === 'denegado' && (
                            <div className="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4 text-sm text-center">
                                Por favor, habilita la geolocalización en la configuración de tu navegador para ver a tus vecinos.
                            </div>
                        )}
                        <div className="space-y-4">
                            <h2 className="text-2xl font-bold text-gray-700">Solicitudes Pendientes</h2>
                            {requests.length > 0 ? (
                                requests.map(req => (
                                    <div key={req.id} className="bg-blue-50 p-4 rounded-xl shadow-sm border border-blue-200 flex flex-col md:flex-row justify-between items-center">
                                        <div className="flex-grow text-sm mb-2 md:mb-0">
                                            <p className="font-semibold text-gray-800">Monto: <span className="text-lg font-bold text-green-600">${req.amount.toFixed(2)}</span></p>
                                            <p className="text-gray-600">
                                                Tipo: <span className="font-semibold capitalize">{req.exchangeType}</span>
                                            </p>
                                            <p className="text-gray-600">
                                                Distancia: {req.requesterLocation ? `${getDistance(userLocation, req.requesterLocation)} km` : 'Calculando...'}
                                            </p>
                                            <p className="text-gray-500 break-all">ID del solicitante: {req.requesterId}</p>
                                        </div>
                                        <div className="flex space-x-2">
                                            <button onClick={() => onAccept(req.id)} className="px-4 py-2 bg-green-500 text-white rounded-md shadow-md text-sm hover:bg-green-600 transition duration-150">Aceptar</button>
                                        </div>
                                    </div>
                                ))
                            ) : (
                                <div className="bg-gray-100 p-4 rounded-md text-center text-gray-500">
                                    No hay solicitudes de intercambio cercanas.
                                </div>
                            )}
                        </div>
                        <button
                            onClick={() => setPage('dashboard')}
                            className="w-full mt-6 py-3 px-4 border border-gray-300 rounded-xl shadow-md text-sm font-semibold text-gray-700 bg-white hover:bg-gray-50 transition duration-150 ease-in-out"
                        >
                            Volver al Panel de Control
                        </button>
                    </div>
                </div>
            );
        };

        const MyRequestsPage = ({ requests, userId, setPage }) => {
            return (
                <div className="min-h-screen bg-gray-100 flex flex-col items-center p-4">
                    <div className="bg-white p-6 rounded-2xl shadow-xl w-full max-w-lg mt-10">
                        <h1 className="text-3xl font-bold text-gray-800 mb-4">Mis Solicitudes en CashHood</h1>
                        <div className="space-y-4">
                            {requests.length > 0 ? (
                                requests.map(req => (
                                    <div key={req.id} className={`p-4 rounded-xl shadow-sm border ${req.status === 'pending' ? 'bg-yellow-50 border-yellow-200' : req.status === 'accepted' ? 'bg-green-50 border-green-200' : 'bg-gray-50 border-gray-200'}`}>
                                        <div className="flex items-center justify-between">
                                            <p className="font-semibold text-gray-800">Monto: <span className="text-lg font-bold text-green-600">${req.amount.toFixed(2)}</span></p>
                                            <span className={`text-sm font-medium px-2 py-1 rounded-full ${req.status === 'pending' ? 'bg-yellow-500 text-white' : req.status === 'accepted' ? 'bg-green-500 text-white' : 'bg-gray-500 text-white'}`}>
                                                {req.status === 'pending' ? 'Pendiente' : req.status === 'accepted' ? 'Aceptada' : 'No Disponible'}
                                            </span>
                                        </div>
                                        <div className="mt-2 text-sm text-gray-600">
                                            <p>Tipo: <span className="font-semibold capitalize">{req.exchangeType}</span></p>
                                            {req.requesterId === userId ? (
                                                <p>Tú solicitaste este intercambio.</p>
                                            ) : (
                                                <p>Tú aceptaste este intercambio de {req.requesterEmail}.</p>
                                            )}
                                            {req.status === 'accepted' && (
                                                <p className="mt-1 font-semibold text-green-700">¡El intercambio fue aceptado! Contacta al vecino para coordinar.</p>
                                            )}
                                        </div>
                                    </div>
                                ))
                            ) : (
                                <div className="bg-gray-100 p-4 rounded-md text-center text-gray-500">
                                    No tienes solicitudes de intercambio.
                                </div>
                            )}
                        </div>
                        <button
                            onClick={() => setPage('dashboard')}
                            className="w-full mt-6 py-3 px-4 border border-gray-300 rounded-xl shadow-md text-sm font-semibold text-gray-700 bg-white hover:bg-gray-50 transition duration-150 ease-in-out"
                        >
                            Volver al Panel de Control
                        </button>
                    </div>
                </div>
            );
        };

        window.onload = () => {
            const root = ReactDOM.createRoot(document.getElementById('root'));
            root.render(
                <React.StrictMode>
                    <App />
                </React.StrictMode>
            );
        };
    </script>
</body>
</html>
